#Query 1
WITH daily_hourly_metrics AS (
    -- 1. Calculate transaction count and volume for *each* hour of *each* day
    SELECT
        date_trunc('day', evt_block_time) AS day,
        EXTRACT(HOUR FROM evt_block_time) AS hour_of_day,
        COUNT(evt_tx_hash) AS tx_count_hourly,
        SUM(value / 1e6) AS volume_usdc_hourly
…    AVG(volume_usdc_hourly) AS avg_daily_volume_usdc_per_hour
FROM daily_hourly_metrics
GROUP BY hour_of_day
ORDER BY hour_of_day ASC;

#Query 2 Day of Week Patterns
WITH daily_metrics AS (
    -- 1. Calculate transaction count and volume for *each* day
    SELECT
        date_trunc('day', evt_block_time) AS day,
        EXTRACT(DOW FROM evt_block_time) AS day_of_week_num,
        COUNT(evt_tx_hash) AS tx_count_daily,
        SUM(value / 1e6) AS volume_usdc_daily
…    AVG(tx_count_daily) / AVG(volume_usdc_daily) AS avg_tx_per_usdc_volume
FROM daily_metrics
GROUP BY 1, 2
ORDER BY day_of_week_num;

#Query 3 Stress Period Identification
WITH daily_metrics AS (
    SELECT
        DATE_TRUNC('day', evt_block_time) AS day,
        COUNT(evt_tx_hash) AS tx_count,
        SUM(value / 1e6) AS total_volume
    FROM erc20_ethereum.evt_Transfer
…    (dm.total_volume - s.mean_volume) / NULLIF(s.stddev_volume, 0) AS volume_z_score
FROM daily_metrics dm
CROSS JOIN stats s
ORDER BY dm.day DESC;

#Query 4 Transaction Size During Stress vs Normal Days
WITH daily_metrics AS (
    SELECT
        DATE_TRUNC('day', evt_block_time) AS day,
        COUNT(evt_tx_hash) AS tx_count
    FROM erc20_ethereum.evt_Transfer
    WHERE
        contract_address = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
…    t.contract_address = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
    AND t.evt_block_time >= NOW() - INTERVAL '6' MONTH
GROUP BY 1, 2
ORDER BY cd.period_type,
    -- Numerical ordering of size buckets for correct chart display
    CASE size_bucket
        WHEN '< $1K' THEN 1 WHEN '$1K-$10K' THEN 2
        WHEN '$10K-$100K' THEN 3 WHEN '$100K-$1M' THEN 4 ELSE 5 END;

#Query 5 Hourly Patterns 

WITH daily_metrics AS (
    SELECT DATE_TRUNC('day', evt_block_time) AS day, COUNT(evt_tx_hash) AS tx_count
    FROM erc20_ethereum.evt_Transfer
    WHERE
        contract_address = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
        AND evt_block_time >= NOW() - INTERVAL '6' MONTH
    GROUP BY 1
…)
SELECT
    h.hour_of_day,
    h.period_type,
    -- Calculate the average daily count and volume for that hour/period type
    CAST(h.total_tx_count AS DOUBLE) / dc.num_days AS average_daily_tx_count,
    h.total_volume_usdc / dc.num_days AS average_daily_volume_usdc
FROM hourly_period_totals h
INNER JOIN day_counts dc ON h.period_type = dc.period_type
ORDER BY h.period_type, h.hour_of_day;

#Query 6 ETH Price Volativity Correlation
WITH usdc_daily AS (
    SELECT
        DATE_TRUNC('day', evt_block_time) AS day,
        COUNT(evt_tx_hash) AS usdc_tx_count,
        SUM(value / 1e6) AS usdc_volume
    FROM erc20_ethereum.evt_Transfer
    WHERE
…    CASE
        WHEN e.daily_swing_pct > 10 THEN 'HIGH_VOLATILITY'
        WHEN e.daily_swing_pct > 5 THEN 'MODERATE'
        ELSE 'LOW_VOLATILITY'
    END AS market_condition
FROM usdc_daily u
LEFT JOIN eth_volatility e ON u.day = e.day
WHERE e.day IS NOT NULL -- Exclude days where ETH price data is missing
ORDER BY u.day DESC;

#Query 7 Gas Price Impact
WITH hourly_usdc AS (
    SELECT
        DATE_TRUNC('hour', evt_block_time) AS hour,
        COUNT(evt_tx_hash) AS usdc_tx_count,
        SUM(value / 1e6) AS usdc_volume
    FROM erc20_ethereum.evt_Transfer
    WHERE
…        WHEN g.avg_gas_gwei > 100 THEN 'HIGH_CONGESTION'
        WHEN g.avg_gas_gwei > 50 THEN 'MODERATE'
        ELSE 'LOW_CONGESTION'
    END AS network_condition
FROM hourly_usdc u
LEFT JOIN gas_metrics g ON u.hour = g.hour
WHERE g.hour IS NOT NULL
ORDER BY u.hour ASC; -- Order by hour chronologically
